---
layout: post
title: Uploading a file using FTP and the WebClient
---

<i><b>Note:</b> more detailed documentation for the .NET 4.0 explains the reason for requiring the additional slash (/). See the <a href="http://msdn.microsoft.com/en-us/library/system.net.ftpwebrequest.aspx">remarks section for the FtpWebRequest class</a>. If you are using .NET 4.0, this class is probably a better bet.</i><br /><br />I ran into some trouble uploading a file using the System.Net.WebClient. Looking at examples in the web, it seemed quite straightforward, but I found that I needed to include an additional forward slash in order to get the transfer to work correctly.<br /><br />At first, I struggled to upload a file with this call to my WebClient instance:<br /><br /><pre class="brush: csharp;">client.UploadFile("ftp://sssssss/folder/folder/folder/t.txt", @"c:\temp\t.txt");<br /></pre><br />I was able to download a file in that location with Internet Explorer using the URI above, but not upload to it using the WebClient.<br /><br />This dump from Wireshark illustrates the problem (note line 14), which seems to be a bug in the WebClient to me:<br /><br /><pre class="brush: plain;">220 sssssss FTP server (Version 1.1.214.4(PHNE_38458) Tue Jul 29 07:36:52 GMT 2008) ready.<br />USER uuuuuuu<br />331 Password required for uuuuuuu.<br />PASS ppppppp<br />230 User uuuuuuulogged in.<br />OPTS utf8 on<br />500 'OPTS utf8 on': command not understood.<br />PWD<br />257 "/home/fld/uuuuuuu" is current directory.<br />TYPE I<br />200 Type set to I.<br />PASV<br />227 Entering Passive Mode (xx,xx,xx,xx,xx,xx)<br />STOR folder/folder/folder/t.txt<br />553 Could not determine cwdir: No such file or directory.<br />221 You could at least say goodbye.<br /></pre><br />Noticing that the STOR command was providing a relative path (not starting with /), I assume that the server was trying to save the file into the current folder i.e. /home/fld/uuuuuuu/folder/folder/folder/t.txt. To test this theory, I added a slash at the beginning ot the path:<br /><br /><pre class="brush: csharp;">client.UploadFile("ftp://sssssss//folder/folder/folder/t.txt", @"c:\temp\t.txt");<br /></pre><br />I am not sure if this is a valid URI, but it seems to work with the WebClient, although I am not sure why the RETR command (line 19) is executed as in the following Wireshark dump:<br /><br /><pre class="brush: plain">220 sssssss FTP server (Version 1.1.214.4(PHNE_38458) Tue Jul 29 07:36:52 GMT 2008) ready.<br />USER uuuuuuu<br />331 Password required for uuuuuuu.<br />PASS ppppppp<br />230 User uuuuuuu logged in.<br />OPTS utf8 on<br />500 'OPTS utf8 on': command not understood.<br />PWD<br />257 "/home/fld/uuuuuuu" is current directory.<br />TYPE I<br />200 Type set to I.<br />PASV<br />227 Entering Passive Mode (xx,xx,xx,xx,xx,xx)<br />STOR /folder/folder/folder/t.txt<br />150 Opening BINARY mode data connection for /folder/folder/folder/t.txt.<br />226 Transfer complete.<br />PASV<br />227 Entering Passive Mode (xx,xx,xx,xx,xx,xx)<br />RETR folder/folder/folder/t.txt<br />550 folder/folder/folder/t.txt: No such file or directory.<br />221 You could at least say goodbye.<br /></pre><br /><br />This is the final code that seems to work:<br /><br /><pre class="brush: csharp;">        public static void SendFile(string sourcePath, string server, string userName, string password, string remoteFolder, string remoteFileName)<br />        {<br />            using (WebClient client = new WebClient())<br />            {<br />                string dest = string.Format(CultureInfo.InvariantCulture, "ftp://{0}/{1}/{2}", server, remoteFolder, remoteFileName);<br />                client.Credentials = new NetworkCredential(userName, password);<br />                client.Proxy = null;<br />                client.UploadFile(dest, sourcePath);<br />            }<br />        }<br /></pre><br />And the corresponding integration test:<br /><br /><pre class="brush: csharp">        [TestMethod]<br />        public void ShouldSubmitFileToFtpServer()<br />        {<br />            Guid uniqueId = Guid.NewGuid();<br /><br />            string tempFile = Path.Combine(Path.GetTempPath(), "FtpTestFile.txt");<br />            File.WriteAllText(tempFile, "Test file - safe to delete. " + uniqueId.ToString());<br /><br />            string server = "sssssss";<br />            string userName = "uuuuuuu";<br />            string password = "ppppppp";<br />            string folder = "/folder/folder/folder";<br />            string fileName = "t.txt";<br />            Ftp.SendFile(tempFile, server, userName, password, folder, fileName);<br /><br />            string tempFileDown = tempFile + ".down";<br /><br />            if(File.Exists(tempFileDown)) File.Delete(tempFileDown);<br /><br />            using (WebClient client = new WebClient())<br />            {<br />                client.Credentials = new NetworkCredential(userName, password);<br />                string ftpLink = String.Format(CultureInfo.InvariantCulture, "ftp://{0}/{1}/{2}", server, folder, fileName);<br />                client.CachePolicy = new HttpRequestCachePolicy(HttpRequestCacheLevel.NoCacheNoStore);<br />                client.DownloadFile(ftpLink, tempFileDown);<br />            }<br /><br />            string content = File.ReadAllText(tempFileDown);<br /><br />            Assert.IsTrue(content.Contains(uniqueId.ToString()));<br />        }<br /></pre>
