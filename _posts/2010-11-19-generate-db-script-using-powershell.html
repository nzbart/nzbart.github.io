---
layout: post
title: Generate DB script using PowerShell
---

This is an example script that can be used to dump a SQL Server database schema into a creation script. The advantages of this method over using SQL Server Management Studio include:<br /><ul><li>Scriptable. Can be included in a build or commit script.</li><li>Repeatable. SQL Server Management Studio generated scripts vary from run to run, so it can be difficult to make comparisons with previous versions of the schema in source control.</li><li>Repeatable. Using the SQL Server Management Studio GUI to create scripts relies on everyone ticking the same boxes to generate consistent and correct DB scripts.</li><li>Configurable. This script ignores objects (e.g. tables and triggers) with names starting with 'test'.<br /></ul><pre class="brush: ps;">&lt;#<br />.SYNOPSIS<br />.NOTES<br />Author: <br />#&gt;<br /><br />$root = resolve-path ((split-path -path $MyInvocation.MyCommand.Definition -Parent) + '\..\..');<br />$serverURL = 'SQL2005'<br />$databaseName = "DBToDump";<br />$scriptFile = "$root\Scripts\Create.sql"<br /><br />#================== GetObjectsFromDB ===================<br />function GetObjectsFromDB(<br />[parameter(mandatory=$true)]$Database, <br />[parameter(mandatory=$true)][string]$ObjectType)<br />{<br />    $objects = [Microsoft.SqlServer.Management.Smo.SqlSmoObject[]]($database.$ObjectType | Where-object {$_.IsSystemObject -ne $true -and $_.IsFixedRole -ne $true -and $_.Name -notmatch '^test' } );<br />    if($objects)<br />    {<br />        ,$objects<br />    }<br />    else<br />    {<br />        ,@()<br />    }<br />}<br />#=======================================================<br /><br />[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.SqlServer.SMO") | out-null<br />$server = new-object Microsoft.SqlServer.Management.Smo.Server ($serverURL);<br />$server.SetDefaultInitFields([Microsoft.SqlServer.Management.SMO.StoredProcedure], "IsSystemObject")<br />$db = $server.Databases[$databaseName];<br /><br />if(Test-Path $scriptFile)<br />{<br />    del $scriptFile<br />}<br /><br />$scripter = new-object Microsoft.SqlServer.Management.Smo.Scripter ($server);<br />$options = $scripter.Options<br />$options.ScriptDrops = $false<br />$options.IncludeIfNotExists = $false<br />$options.ScriptData = $false<br />$options.NoCommandTerminator = $false<br />$options.FileName = $scriptFile<br />$options.SchemaQualify = $true<br />$options.ToFileOnly = $true<br />$options.AppendToFile = $true<br />$options.DriAllConstraints = $true<br />$options.Indexes = $true<br />$options.ClusteredIndexes = $true<br />$options.Statistics = $true<br />$options.IncludeDatabaseRoleMemberships = $true<br />$options.TargetServerVersion = [Microsoft.SqlServer.Management.Smo.SqlServerVersion]::Version90<br />$options.NoFileGroup = $true<br />$options.DriAll = $true<br /><br />echo "Scripting database..."<br />$scripter.EnumScript($db)<br /><br />#don't script collation for DB objects since it has been done for the database as a whole<br />$options.NoCollation = $true<br /><br />#switch to newly created DB<br />"<br />USE [$databaseName]<br />GO<br />" | out-file -append $scriptFile -ErrorAction stop<br /><br />$objects = GetObjectsFromDB $db "Schemas"<br />$objects += GetObjectsFromDB $db "Roles"<br />$objects += GetObjectsFromDB $db "Tables"<br />$objects += GetObjectsFromDB $db "UserDefinedFunctions"<br />$objects += GetObjectsFromDB $db "StoredProcedures"<br />$objects += GetObjectsFromDB $db "Views"<br /><br />$scripter.EnumScript($objects)<br /><br />echo "Done."<br /><br />#set permissions (not sure how to script the ones I want without including test permissions)<br />"<br />GRANT EXECUTE ON SCHEMA::[app] TO [application] AS [dbo]<br />GO<br />GRANT SELECT ON SCHEMA::[cfg] TO [application] AS [dbo]<br />GO<br />GRANT SELECT ON SCHEMA::[cfg] TO [support] AS [dbo]<br />GO<br />GRANT SELECT ON SCHEMA::[dbo] TO [support] AS [dbo]<br />GO<br />GRANT UPDATE ON SCHEMA::[cfg] TO [support] AS [dbo]<br />GO<br />GRANT SELECT ON SCHEMA::[sup] TO [support] AS [dbo]<br />GO<br />GRANT VIEW DEFINITION ON SCHEMA::[sup] TO [support] AS [dbo]<br />GO<br />GRANT VIEW DEFINITION ON SCHEMA::[cfg] TO [support] AS [dbo]<br />GO<br />GRANT VIEW DEFINITION ON SCHEMA::[dbo] TO [support] AS [dbo]<br />GO<br />GRANT EXECUTE ON SCHEMA::[sup] TO [support] AS [dbo]<br />GO" | out-file -append $scriptFile -ErrorAction stop<br /></pre>
