---
layout: post
title: Keeping track of system freezes with PowerShell
---

A colleague has been having some problems with her Windows 7 x64 machines freezing and requiring a forced shut-down. Unfortunately, these are not logged in the reliability monitor, but they are logged in the event log. I used PowerShell to process the event log to find start-up and shut-down events:<br /><br /><pre class="brush:ps">#Based on information from http://support.microsoft.com/kb/196452<br /><br />$results = @()<br /><br />function GetResult($time, $message)<br />{<br />    return New-Object psobject -Property @{ Time = $time; Message = $message };<br />}<br /><br />Get-EventLog System | ? { $_.Source -eq "EventLog" -and 6006,6008,6009 -contains $_.EventId } | % {<br />    $item = $_<br />    switch($_.EventID)<br />    {<br />        6006 { $results += (GetResult $item.TimeGenerated "Clean shutdown") }<br />        6008 <br />        { <br />            if(-not ($item.Message -match "^The previous system shutdown at (.*) on (.*) was unexpected.$"))<br />            {<br />                throw "Invalid format."<br />            }<br />            $c = ($matches[2] -replace '\u200E','') + " " + ($matches[1] -replace '\u200E','');  #not sure why, but it includes the unicode character 'LEFT-TO-RIGHT MARK'<br />            $dt = [datetime]::parse($c)<br />            $results += (GetResult $dt "Dirty shutdown")<br />        }<br />        6009 { $results += (GetResult $item.TimeGenerated "Start-up") }<br />    }<br />}<br /><br />$results | sort Time -Descending<br /></pre><br />Running the script will create output similar to this:<br /><pre class="brush:plain">.\ShutdownEvent.ps1<br /><br />Message        Time<br />-------        ----<br />Start-up       7/01/2011 13:34:38<br />Dirty shutdown 7/01/2011 13:18:22<br />Start-up       7/01/2011 08:18:25<br />Clean shutdown 6/01/2011 16:44:41<br />Start-up       6/01/2011 08:19:52<br />Clean shutdown 5/01/2011 16:42:38<br />Start-up       5/01/2011 08:18:23<br />Clean shutdown 31/12/2010 16:21:51<br />Start-up       31/12/2010 08:50:07<br />Clean shutdown 30/12/2010 16:36:55<br />Start-up       30/12/2010 08:49:39<br />Clean shutdown 29/12/2010 16:37:34<br />Start-up       29/12/2010 08:50:48<br />Clean shutdown 24/12/2010 09:52:04<br />Start-up       24/12/2010 08:46:15<br />Clean shutdown 23/12/2010 13:25:19<br />Start-up       23/12/2010 08:02:46<br />Clean shutdown 22/12/2010 16:37:40<br />Start-up       22/12/2010 08:02:18<br />Clean shutdown 21/12/2010 16:35:55<br />Start-up       21/12/2010 08:02:13<br />Clean shutdown 20/12/2010 16:32:50<br />Start-up       20/12/2010 08:01:52<br /></pre><br /><br />You can also filter the output, for example to only show dirty shut-down events:<br /><br /><pre class="brush:plain">.\ShutdownEvent.ps1 | ? { $_.Message -match 'Dirty.*' }<br /><br />Message        Time<br />-------        ----<br />Dirty shutdown 7/01/2011 13:18:22<br />Dirty shutdown 16/09/2010 08:23:41<br />Dirty shutdown 9/09/2010 11:04:31<br />Dirty shutdown 19/07/2010 11:35:27<br />Dirty shutdown 14/07/2010 13:52:24<br />Dirty shutdown 8/07/2010 13:40:26<br />Dirty shutdown 7/05/2010 08:22:57<br /></pre>
