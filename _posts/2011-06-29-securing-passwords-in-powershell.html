---
layout: post
title: Securing passwords in PowerShell
---

It is sometimes necessary to use plaintext passwords in PowerShell scripts, but obviously not a good idea to have those passwords stored in cleartext on disk. The solution is to use the PowerShell <a href="http://technet.microsoft.com/en-us/library/dd347656.aspx">ConvertTo-SecureString</a> and <a href="http://technet.microsoft.com/en-us/library/dd315356.aspx">ConvertFrom-SecureString</a> cmdlets to encrypt the password, save it to a file, and then decrypt it in memory when required. I ported <a href="http://blogs.msdn.com/b/fpintos/archive/2009/06/12/how-to-properly-convert-securestring-to-string.aspx">this function</a> to PowerShell for properly converting the SecureString to a string. <br /><br />The code below uses the default encryption method, which is specific to the logged in user (or, more precisely, the user that is running the code). Note that, for machines that have joined a domain, a domain administrator can decrypt your data by resetting your password. No other users can decrypt your data.<br /><br /><h3>Encrypt password and save to a file</h3><pre class="brush:ps">$secureStringPassword = Read-Host "Enter the password" -AsSecureString<br />$encryptedPassword = ConvertFrom-SecureString $secureStringPassword<br />Set-Content -Path Password.bin -Value $encryptedPassword<br /></pre><br /><h3>Load and decrypt the password in memory</h3><pre class="brush:ps">function ConvertToUnsecureString(<br />    [System.Security.SecureString][parameter(mandatory=$true)]$SecurePassword)<br />{<br />    $unmanagedString = [System.IntPtr]::Zero;<br />    try<br />    {<br />        $unmanagedString = [Runtime.InteropServices.Marshal]::SecureStringToGlobalAllocUnicode($SecurePassword)<br />        return [Runtime.InteropServices.Marshal]::PtrToStringUni($unmanagedString)<br />    }<br />    finally<br />    {<br />        [Runtime.InteropServices.Marshal]::ZeroFreeGlobalAllocUnicode($unmanagedString)<br />    }<br />}<br /><br />$encryptedPassword = Get-Content -Path Password.bin<br />$secureStringPassword = ConvertTo-SecureString -String $encryptedPassword<br />$password = ConvertToUnsecureString $secureStringPassword <br /></pre>
