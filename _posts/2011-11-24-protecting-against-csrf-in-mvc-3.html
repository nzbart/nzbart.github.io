---
layout: post
title: Protecting against CSRF in MVC 3
---

It is important to protect your customers and other users of your website against <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">CSRF attacks</a>. To do this in ASP.NET MVC 3, you would normally use the <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.validateantiforgerytokenattribute.aspx">ValidateAntiForgeryTokenAttribute</a>. The test below will ensure that all appropriate actions on all controllers have this protection.  <pre class="brush:csharp"><br />[TestMethod]<br />public void All_post_actions_validate_anti_forgery_tokens()<br />{<br />    var modelController = typeof(MyController);  //this can be any one of your controllers in this particular area<br />    var allControllers = modelController.Assembly.GetTypes().Where(t => t.Namespace == modelController.Namespace && t.Name.EndsWith("Controller", StringComparison.OrdinalIgnoreCase));<br />    foreach (var controller in allControllers)<br />    {<br />        AssertControllerValidatesAntiForgeryToken(controller);<br />    }<br />}<br /><br />static void AssertControllerValidatesAntiForgeryToken(Type controller)<br />{<br />    Console.WriteLine("Checking " + controller.Name);<br />    var violations = (<br />        from method in controller.GetMethods()<br />        let attributes = method.GetCustomAttributes(true)<br />        let parameters = method.GetParameters()<br />        let isProperty = !method.Name.StartsWith("set_", StringComparison.OrdinalIgnoreCase) && !method.Name.StartsWith("get_", StringComparison.OrdinalIgnoreCase)<br />        let isPostMethod = parameters.Length != 0 && (!attributes.Any(a => a is ActionMethodSelectorAttribute) || attributes.Any(a => a is HttpPostAttribute))<br />        let noAntiForgeryToken = !attributes.Any(a => a is ValidateAntiForgeryTokenAttribute)<br />        let excludedMethods = typeof(ControllerBase).GetMethods().Select(m => m.Name)<br />        let isExcludedMethod = excludedMethods.Contains(method.Name)<br />        where isProperty && isPostMethod && noAntiForgeryToken && !isExcludedMethod<br />        select method.Name).ToArray();<br /><br />    foreach (var violation in violations)<br />        Console.WriteLine("Failed: {0}/{1}", controller.Name, violation);<br /><br />    Assert.AreEqual(0, violations.Count());<br />}         <br /></pre>
