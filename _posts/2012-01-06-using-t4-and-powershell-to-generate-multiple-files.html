---
layout: post
title: Using T4 and PowerShell to generate multiple files
---

Some parts of a SQL script, such as user or server names, will differ between environments. SQL is not well suited to reading this from configuration files (along with many other significant problems such as difficulty writing DRY code), so the best - or maybe only - solution I've found is to write multiple SQL scripts, one for each environment. Until recently, I have generated different SQL scripts for different deployment environments by using basic find-and-replace in PowerShell. I thought that the Visual Studio T4 template engine might provide a more elegant solution to the problem.  Below is a simple PowerShell script that will, when coupled with a SQL script T4 template, generate one version for each environment.   <pre class="brush"><br />$scriptFolder = Split-Path -Path $MyInvocation.MyCommand.Definition -Parent<br /><br />$t4exe = ${env:ProgramFiles(x86)} + "\Common Files\Microsoft Shared\TextTemplating\10.0\TextTransform.exe"<br />if(-not(test-path $t4exe)) {<br />                throw "Unable to find TextTransform.exe."<br />}<br /><br />@("Create.sql", "DEV", @{ SomethingEnvironmentSpecific = "Data for DEV"; SomethingElseEnvironmentSpecific = "More DEV data" }),<br />@("Create.sql", "TEST", @{ SomethingEnvironmentSpecific = "Data for TEST"; SomethingElseEnvironmentSpecific = "More TEST data" }),<br />@("Create.sql", "PREPROD", @{ SomethingEnvironmentSpecific = "Data for PREPROD"; SomethingElseEnvironmentSpecific = "More PREPROD data" }),<br />@("Create.sql", "PROD", @{ SomethingEnvironmentSpecific = "Data for PROD"; SomethingElseEnvironmentSpecific = "More PROD data" }) |<br />% {<br />                $template = join-path $scriptFolder ($_[0] + ".tt")<br />                $outfile = join-path $scriptFolder ($_[1] + "_" + $_[0])<br />                $values = $_[2]<br /><br />                $cmd = "& `"$t4exe`" -out `"$outfile`""<br />                $values.GetEnumerator() | % { $cmd += " -a !!`"" + $_.Name + "`"!`"" + $_.Value + "`"" }<br />                $cmd += " `"$template`""<br /><br />                Write-Host "Executing: $cmd"<br />    iex $cmd<br />}<br /></pre>
