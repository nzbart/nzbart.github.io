---
layout: post
title: Work with a "shadow copy" of your file system
---

Sometimes it is useful to be able to take a snapshot of the file system as it currently stands while still having programs use / access it. The reason I wrote this PowerShell script is that I want to be able to copy virtual machines around while still accessing them. Unfortunately, copying virtual machines takes a long time due to their size, so it is useful to be able to copy them while they are in use. This script allows me to shut down the virtual machine, start the copy operation, and then restart the virtual machine while the copy is still in progress.<br /><br />Notes / caveats:<br /><br /><ul><li>This script requires administrative privileges.</li><li>The script is naive and does not work if the folder you want to work with is inside a mount point or directory junction (this situation is usually rare).</li><li>The script leaves a symbolic link in the temp folder, so these may accumulate over time. </li></ul><br /><pre class="brush:ps">function CreateShadowCopy([string]$LocationToOpen) {<br />    if(-not $LocationToOpen -or -not (test-path $LocationToOpen)) {<br />        $LocationToOpen = get-location<br />    }<br />    if(-not (get-item $LocationToOpen).PSIsContainer) {<br />        $LocationToOpen = split-path -Parent $LocationToOpen<br />    }<br /> <br />    $fullPath = (resolve-path $LocationToOpen).Path<br />    $fileRoot = [system.io.path]::GetPathRoot($fullPath)<br />    $shadow = (Get-WmiObject -list win32_shadowcopy).Create($fileRoot, "ClientAccessible") <br />    $shadowRoot = join-path $env:temp $shadow.ShadowID<br />    $shadowPath = gwmi win32_shadowcopy | ? { $_.Id -eq $shadow.ShadowID } | select -ExpandProperty DeviceObject<br />    cmd /c mklink /d $shadowRoot $shadowPath\ | out-null<br />    $rootlessCurrentPath = $fullPath.substring($fileRoot.length)<br />    join-path $shadowRoot $rootlessCurrentPath<br />}<br /><br />$shadowPath = CreateShadowCopy D:\<br />try {<br />    pushd $shadowPath<br /><br />    ls .<br />    echo "Do stuff..."<br />}<br />finally {<br />    popd<br />    cmd /c rd $shadowPath<br />}<br /></pre>
